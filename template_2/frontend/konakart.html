<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<title>jQuery UI Example Page</title>

<link type="text/css" href="../css/jquery-ui-1.8.16.custom.css" rel="stylesheet">
<link type="text/css" href="../css/kkCart.css" rel="stylesheet">

<script type="text/javascript" src="../js/jquery.konakart-7.1.1.1.min.js"></script>
<script type="text/javascript" src="../js/jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="../js/jquery-ui-1.8.16.custom.min.js"></script>
<script type="text/javascript" src="../js/jquery.json-2.3.min.js"></script>


<script type="text/javascript">
    /*
     This demo application demonstrates how to use the KonaKart JQuery JSON library.
     It contains a number of API calls to the KK engine. The flow is as follows:
         1) A temporary customer id (negative number) is fetched from the KK engine.
            This id is used to identify the customer even though he hasn't logged in.
         2) The category tree is fetched from the KK engine and 4 hardware categories
            are used to create 4 tab folders.
         3) Each tab folder is populated with products which again are retrieved from
            the KK engine.
         4) Any product may be added to the cart by dragging it onto the cart tile.
            When this occurs, the code calls the KK engine to add a product to the cart.
         5) Once the product has been added to the cart, an API call is made to retrieve
            all of the cart items for the temporary customer which are then displayed
            in the cart tile.
         6) If a product is removed from the cart, the KK engine is notified through an
            API call and a new updated list of cart items is retrieved from the KK engine
            and displayed.
         7) When the checkout button is clicked, the temporary customer id is saved by the engine
            in an SSO token and a UUID is returned to identify the token.
         8) The current window location is changed in order to redirect the customer to the
            standard KK store-front demo application. The UUID is passed to the struts action
            so that code within the store-front app can look up the SSO token containing the
            temporary customer id. Using this id, the store front app can display the cart items
            and start the checkout process.
     */

    // Change the root depending on where KK is running
    var kkRoot = 'http://67.207.156.121:8780/konakart/';
    //var kkRoot = 'http://www.konakart.com/konakart/';

    // Define the protocol: json or jsonp
    var jsonProtocol = 'json';
    //var jsonProtocol = 'jsonp';

    // Define the url and store id of a running KK engine
    var conf = new engineConfig(kkRoot + 'konakartjson');
    conf.storeId = "store1";
    conf.protocol = jsonProtocol;
    var eng = new kkEng(conf);

    // Use the image base to display images from the KK store-front app
    var imgBase = kkRoot + "images/";

    // Temporary customer id
    var custId = null;

    // Global animation speed setting
    var speed = 700;

    // Cart Empty text
    var cartEmptyTxt = "Your Cart is Empty";

    $(function() {

        // When json and IE we change the AJAX transport to support CORS
        if (jsonProtocol == 'json') {
            ieCORSSupport();
        }

        // Add a label to the cart
        $('#cartItems').find('ul').append('<li>' + cartEmptyTxt + '</li>');

        /*
         Get a temporary customer id Callback. A KK customer that isn't logged in,
         is identified by a temporary id which is always negative. We get this unique
         id from the engine and use it when adding items to the cart.
         */
        var getTempCustomerIdCallback = function(result, textStatus, jqXHR) {
            custId = decodeJson(result);
        }

        // Get a temporary customer id Eng Call
        kkEng.getTempCustomerId(getTempCustomerIdCallback, null, eng);

        // Create the checkout button
        var checkoutBtn = $('.checkout').button();

        // Get basket Callback. Called after a product is added or removed from the cart.
        // The cart items are received from the engine and displayed.
        var getBasketItemsPerCustomerCallback = function(result, textStatus,
                jqXHR) {
            var basketArray = decodeJson(result);

            // Calculate the total and update the cart tile
            var cartList = $('#cartItems').find('ul');

            if (cartList.find('li').first().text() == cartEmptyTxt) {
                // Remove the Cart is Empty Text
                cartList.find('li').first().remove();
                // Show the total
                $('#cartTotal').fadeIn();
                //Show the checkout button
                checkoutBtn.delay(speed).fadeIn(speed);
            }

            // Cart is empty
            if (basketArray.length == 0) {

                // Hide the total
                $('#cartTotal').slideUp(speed);

                //Hide the checkout button
                checkoutBtn.slideUp(speed, function() {
                    cartList.find('li').remove();
                    cartList.append('<li>' + cartEmptyTxt + '</li>').hide()
                            .slideDown(speed);
                    $('#cartTotal').find('ul')
                            .replaceWith("<ul><li></li></ul>");

                });
                return;
            }

            // Remove current items
            cartList.find('li').remove();

            // Add new items received from KK engine
            var total = 0;
            for ( var i = 0; i < basketArray.length; i++) {
                var basket = basketArray[i];
                cartList.append('<li>'
                        + '<a class="remove" id="'+basket.id+'">&times;</a>'
                        + basket.quantity + ' x ' + basket.product.name
                        + '</li>');
                total += basket.finalPriceExTax;
            }

            // Fade in the new total
            $('#cartTotal').find('ul').fadeOut(
                    speed,
                    function() {
                        $(this).replaceWith(
                                '<ul><li>Total: ' + formatCurrency(total)
                                        + '</li></ul>');
                        $('#cartTotal').find('ul').hide().fadeIn(speed);
                    });

        }

        // Remove from basket Callback
        var removeFromBasketCallback = function(result, textStatus, jqXHR) {
            // Get the basket items from the engine
            kkEng.getBasketItemsPerCustomer(null, custId, -1,
                    getBasketItemsPerCustomerCallback, null, eng);
        }

        // Add to basket Callback
        var addToBasketCallback = function(result, textStatus, jqXHR) {
            // Get the basket items from the engine
            kkEng.getBasketItemsPerCustomer(null, custId, -1,
                    getBasketItemsPerCustomerCallback, null, eng);
        }

        // Drop a product into the cart
        $('#cart').droppable(
                {
                    accept : '.products li',
                    tolerance : 'pointer',
                    hoverClass : 'cartHover',
                    drop : function(event, ui) {
                        var item = ui.draggable;
                        var prodId = $(item).find('.info').find('.prodId')
                                .text();

                        // Create a KonaKart basket item and send it to the engine
                        var basket = new Basket();
                        basket.quantity = 1;
                        basket.productId = prodId;
                        kkEng.addToBasket(null, custId, basket,
                                addToBasketCallback, null, eng);

                    }
                });

        // Fill folders with products
        var getProductsPerCategoryCallback = function(result, textStatus, jqXHR) {
            // "this" maps to the Category object passed as the context
            var products = decodeJson(result);
            for ( var i = 0; i < products.productArray.length; i++) {
                var prod = products.productArray[i];
                var prodDesc = '<li><img src="'+imgBase+prod.image+'">';
                prodDesc += '<p class="info"><em>' + prod.name + '</em>';
                prodDesc += '<span class="prodId" style="display: none">'
                        + prod.id + '</span>';
                prodDesc += '<span class="price">'
                        + formatCurrency((prod.specialPriceExTax == null) ? prod.priceExTax
                                : prod.specialPriceExTax) + '</span>';
                prodDesc += '<p>';
                if (prod.description.length > 150) {
                    prodDesc += prod.description.substring(0, 149) + "...";
                } else {
                    prodDesc += prod.description;
                }
                prodDesc += '</p>';
                prodDesc += '</em></p>';
                prodDesc += '</li>';

                $('#cat-' + this.id + ' ul').append(prodDesc);
            }
            $('#cat-' + this.id).find('ul').find('li').draggable({
                opacity : 0.5,
                revert : true,
                revertDuration : 500,
            });
        };

        // Create folders
        $('#store').tabs();

        // Fill folder titles with category information. We only use 4 hardware categories from the
        // KK demo store-front application
        var dataDesc = new DataDescriptor();
        dataDesc.limit = 100;
        dataDesc.fillDescription = true;
        var getCategoryTreeCallback = function(result, textStatus, jqXHR) {
            var categories = decodeJson(result);
            for ( var i = 0; i < categories.length; i++) {

                if (categories[i].name == "Computer Peripherals") {
                    var folders = $('#store').find('ul');
                    for ( var j = 0; j < categories[i].children.length; j++) {
                        var childCat = categories[i].children[j];
                        if (childCat.name == 'Graphics Cards'
                                || childCat.name == 'Printers'
                                || childCat.name == 'Keyboards'
                                || childCat.name == 'Mice') {

                            $('#store').tabs("add", '#cat-' + childCat.id,
                                    childCat.name);

                            // Hide data in all tabs after the first one
                            if (j > 1) {
                                $('#store').find('#cat-' + childCat.id)
                                        .addClass('ui-tabs-hide');
                            }
                            // Create a list to put the products
                            $('#store').find('#cat-' + childCat.id).append(
                                    '<ul class="products"></ul>');

                            // Get products for the category passing the category in the context
                            kkEng.getProductsPerCategory(null, dataDesc,
                                    childCat.id, false, -1,
                                    getProductsPerCategoryCallback, childCat,
                                    eng);
                        }
                    }
                }
            }
        };

        // Get the category tree from the KK engine
        kkEng.getCategoryTree(-1, true, getCategoryTreeCallback, null, eng);

        // Basket remove link clicked
        $('.remove').live(
                'click',
                function(event) {
                    $('#' + event.target.id).parent().slideUp(
                            speed,
                            function() {
                                var basket = new Basket();
                                basket.id = event.target.id;
                                kkEng.removeFromBasket(null, custId, basket,
                                        removeFromBasketCallback, null, eng);

                            });
                });

        // saveSSOTokenCallback
        var saveSSOTokenCallback = function(result, textStatus, jqXHR) {
            var secretKey = decodeJson(result);
            /*
             Go to the KK store-front application passing it a key from which it can
             retrieve the SSO token containing the temporary customer id and so retrieve the basket items.
             Look at the source of InitFromTokenSubmitAction to see what the KK store front app does.
             */
            window.location = kkRoot + "InitFromToken.action?key=" + secretKey;
        }

        // Click the checkout button
        $(checkoutBtn).click(
                function() {
                    $('#dialog-confirm').dialog(
                            {
                                resizable : false,
                                height : 140,
                                modal : true,
                                buttons : [
                                        {
                                            text : "No, keep shopping!",
                                            click : function() {
                                                $(this).dialog('close');
                                            }
                                        },
                                        {
                                            text : "Yes, check me out",
                                            click : function() {
                                                $(this).dialog('close');
                                                // Save a token containing the temporary customer id
                                                var ssoToken = new SSOToken();
                                                ssoToken.customerId = custId;
                                                kkEng.saveSSOToken(ssoToken,
                                                        saveSSOTokenCallback,
                                                        null, eng);
                                            }
                                        } ]
                            });
                    return false;
                });

        /*
         * For IE8, IE9 we use XDomainRequest instead of XMLHttpRequest. Needed for
         * CORS.
         */
        function ieCORSSupport() {
            if (!jQuery.support.cors && window.XDomainRequest) {
                $.ajaxTransport('json', function(options, originalOptions, jqXHR) {
                    var xdr;

                    return {
                        send : function(_, completeCallback) {
                            xdr = new XDomainRequest();
                            xdr.onload = function() {
                                var responses = {
                                    text : xdr.responseText
                                };

                                completeCallback(200, 'success', responses);
                                // we will assume that the status code is 200,
                                // XDomainRequest rejects all other successful status
                                // codes
                                // see bug
                                // https://connect.microsoft.com/IE/feedback/ViewFeedback.aspx?FeedbackID=334804
                            };
                            xdr.onerror = xdr.ontimeout = function() {
                                var responses = {
                                    text : xdr.responseText
                                };
                                completeCallback(400, 'failed', responses);
                            }

                            xdr.open(options.type, options.url);
                            xdr.send(options.data);
                        },
                        abort : function() {
                            if (xdr) {
                                xdr.abort();
                            }
                        }
                    };
                });
            }
        }

    });

    // Format the currency
    function formatCurrency(amount) {
        var i = parseFloat(amount);
        if (isNaN(i)) {
            i = 0.00;
        }
        var minus = '';
        if (i < 0) {
            minus = '-';
        }
        i = Math.abs(i);
        i = parseInt((i + .005) * 100);
        i = i / 100;
        s = new String(i);
        if (s.indexOf('.') < 0) {
            s += '.00';
        }
        if (s.indexOf('.') == (s.length - 2)) {
            s += '0';
        }
        s = minus + s;
        return '$' + s;
    }
</script>

</head>
<body style="">
    <header class="ui-widget-header ui-corner-all">
        <h1>Discontinued Hardware Store</h1>
        <p>Drag the products into the Shopping Cart</p>
    </header>
    <div id="container" class="ui-helper-clearfix">
        <div id="column_left">
            <div id="store" class="ui-tabs ui-widget ui-widget-content ui-corner-all">
                <ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
                    <!-- Tabs here -->
                <li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#cat-4"><span>Graphics Cards</span></a></li><li class="ui-state-default ui-corner-top"><a href="#cat-8"><span>Keyboards</span></a></li><li class="ui-state-default ui-corner-top"><a href="#cat-9"><span>Mice</span></a></li><li class="ui-state-default ui-corner-top"><a href="#cat-5"><span>Printers</span></a></li></ul>

            <div id="cat-4" class="ui-tabs-panel ui-widget-content ui-corner-bottom"><ul class="products"><li class="ui-draggable" style="position: relative;"><img src="http://67.207.156.121:8780/konakart/images//prod/9/5/9/9/95992CDB-33D0-46BE-A6EF-4C973B3221B5_1_big.jpg"><p class="info"><em>Matrox G200 MMS</em><span class="prodId" style="display: none">1</span><span class="price">$299.99</span></p><p>Reinforcing its position as a multi-monitor trailblazer, Matrox Graphics Inc. has once again developed the most flexible and highly advanced solution...</p><p></p></li><li class="ui-draggable" style="position: relative;"><img src="http://67.207.156.121:8780/konakart/images//prod/7/8/5/7/7857D709-61C6-44C1-A5D4-52E463CBEAA9_1_big.jpg"><p class="info"><em>Matrox G400 32MB</em><span class="prodId" style="display: none">2</span><span class="price">$499.99</span></p><p><b>Dramatically Different High Performance Graphics</b><br><br>Introducing the Millennium G400 Series - a dramatically different, high performance gr...</p><p></p></li></ul></div><div id="cat-8" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"><ul class="products"><li class="ui-draggable" style="position: relative;"><img src="http://67.207.156.121:8780/konakart/images//prod/0/0/1/F/001F1EAA-2910-440E-BB8D-C714E0E859B4_1_big.jpg"><p class="info"><em>Microsoft Internet Keyboard PS/2</em><span class="prodId" style="display: none">25</span><span class="price">$69.99</span></p><p>The Internet Keyboard has 10 Hot Keys on a comfortable standard keyboard design that also includes a detachable palm rest. The Hot Keys allow you to ...</p><p></p></li><li class="ui-draggable" style="position: relative;"><img src="http://67.207.156.121:8780/konakart/images//prod/E/3/8/4/E384D77F-69C0-4DA9-97DE-32F042B437DB_1_big.jpg"><p class="info"><em>Bundle Saver</em><span class="prodId" style="display: none">28</span><span class="price">$121.45</span></p><p>Buy the Microsoft IntelliMouse Explorer and the Internet Keyboard together, to save  10% on the individual prices and to receive free shipping !</p><p></p></li><li class="ui-draggable" style="position: relative;"><img src="http://67.207.156.121:8780/konakart/images//prod/B/9/9/0/B990FBA5-CCFF-467D-A6ED-230298BB609E_1_big.jpg"><p class="info"><em>Logitech Illuminated Keyboard</em><span class="prodId" style="display: none">31</span><span class="price">$75.99</span></p><p>- Ultra Thin: 9.3 mm profile and transparent frame<br>- Bright, laser-etched, backlighted keys<br>- Sleek, minimalist design<br>- One-touch multimedi...</p><p></p></li></ul></div><div id="cat-9" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"><ul class="products"><li class="ui-draggable" style="position: relative;"><img src="http://67.207.156.121:8780/konakart/images//prod/1/8/5/3/18536902-5B5C-4FF2-859B-A927EE8F38AF_1_big.jpg"><p class="info"><em>Microsoft IntelliMouse Pro</em><span class="prodId" style="display: none">3</span><span class="price">$39.99</span></p><p>Every element of IntelliMouse Pro - from its unique arched shape to the texture of the rubber grip around its base - is the product of extensive cust...</p><p></p></li><li class="ui-draggable" style="position: relative;"><img src="http://67.207.156.121:8780/konakart/images//prod/F/E/F/2/FEF2DB86-728E-4C6A-A3FA-4F4B099D28E6_1_big.jpg"><p class="info"><em>Microsoft IntelliMouse Explorer</em><span class="prodId" style="display: none">26</span><span class="price">$64.95</span></p><p>Microsoft introduces its most advanced mouse, the IntelliMouse Explorer! IntelliMouse Explorer features a sleek design, an industrial-silver finish, ...</p><p></p></li><li class="ui-draggable" style="position: relative;"><img src="http://67.207.156.121:8780/konakart/images//prod/E/3/8/4/E384D77F-69C0-4DA9-97DE-32F042B437DB_1_big.jpg"><p class="info"><em>Bundle Saver</em><span class="prodId" style="display: none">28</span><span class="price">$121.45</span></p><p>Buy the Microsoft IntelliMouse Explorer and the Internet Keyboard together, to save  10% on the individual prices and to receive free shipping !</p><p></p></li></ul></div><div id="cat-5" class="ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"><ul class="products"><li class="ui-draggable" style="position: relative;"><img src="http://67.207.156.121:8780/konakart/images//prod/5/1/B/7/51B73EC2-0845-4837-B125-EC8041C0EA76_1_big.jpg"><p class="info"><em>HP Photosmart 5510 e</em><span class="prodId" style="display: none">27</span><span class="price">$65.00</span></p><p>HP Photosmart 5510 e-All-in-One with Photo value pack<br>(English Version) Print, scan, copy and browse the Web with one convenient device<br>Enjoy s...</p><p></p></li><li class="ui-draggable" style="position: relative;"><img src="http://67.207.156.121:8780/konakart/images//prod/D/A/1/A/DA1A02B1-B200-4125-BBFA-22EE7D01963A_1_big.jpg"><p class="info"><em>Canon I-SENSYS LBP7680CX Printer</em><span class="prodId" style="display: none">30</span><span class="price">$309.99</span></p><p>- Print Speed: Up to 20 ppm<br>- Max Resolution ( Colour ): 9600 dpi x 600 dpi<br>- Total Media Capacity: 300 sheets<br>- Interface: USB, Ethernet</p><p></p></li></ul></div></div>
        </div>
        <div id="column_right">
            <div id="cart" class="ui-widget-header ui-corner-all ui-droppable">
                <div id="cart_head" class="ui-widget-header ui-corner-all">
                    <h2>Shopping Cart</h2>
                </div>
                <div id="cartItems" class="ui-widget-content ui-corner-all">
                    <ul>
                    <li>Your Cart is Empty</li></ul>
                </div>
                <div id="cartTotal" class="ui-widget-content ui-corner-all ui-helper-hidden">
                    <ul>
                        <li></li>
                    </ul>
                </div>
                <a class="checkout ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" href="" style="display: none" role="button"><span class="ui-button-text"> Checkout </span></a>
            </div>
        </div>

        <div id="dialog-confirm" title="Are you sure you want to checkout?" class="ui-helper-hidden"></div>
    </div>




<div id="window-resizer-tooltip"><a href="#" title="Edit settings" style="background-image: url(chrome-extension://kkelicaakdanhinjdeammmilcgefonfh/images/icon_19.png);"></a><span class="tooltipTitle">Window size: </span><span class="tooltipWidth" id="winWidth"></span> x <span class="tooltipHeight" id="winHeight"></span><br><span class="tooltipTitle">Viewport size: </span><span class="tooltipWidth" id="vpWidth"></span> x <span class="tooltipHeight" id="vpHeight"></span></div></body></html>